#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <HardwareSerial.h>
#include <Adafruit_Fingerprint.h>

// ğŸ”¹ WiFi Credentials
const char* ssid = "YourWiFiSSID";
const char* password = "YourWiFiPassword";

// ğŸ”¹ Flask Server IP (Change this to your PCâ€™s IP)
const char* checkUrl = "http://192.168.1.100:5000/get-fingerprints";  
const char* addUrl = "http://192.168.1.100:5000/add-fingerprint";  

// ğŸ”¹ Initialize Fingerprint Sensor (UART2)
HardwareSerial mySerial(2);
Adafruit_Fingerprint finger = Adafruit_Fingerprint(&mySerial);

void setup() {
    Serial.begin(115200);
    delay(3000);
    
    // ğŸ”¹ Connect to WiFi
    Serial.print("Connecting to WiFi...");
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("\nâœ… Connected to WiFi!");

    // ğŸ”¹ Initialize Fingerprint Sensor
    mySerial.begin(57600, SERIAL_8N1, 16, 17);
    finger.begin(57600);
    
    if (finger.verifyPassword()) {
        Serial.println("âœ… Fingerprint sensor detected!");
    } else {
        Serial.println("âŒ Fingerprint sensor NOT found. Check wiring!");
        while (1) delay(1);
    }
    
    Serial.println("Place your finger on the sensor...");
}

void loop() {
    int fingerID = getFingerprintID();

    if (fingerID > 0) {
        Serial.println("ğŸ” Checking if fingerprint is registered...");
        bool isRegistered = checkFingerprintInDB(fingerID);

        if (isRegistered) {
            Serial.println("âœ… Access Granted!");
        } else {
            Serial.println("ğŸš¨ Unregistered Fingerprint Detected!");
            Serial.println("â“ Do you want to register it? (y/n)");

            while (true) {
                if (Serial.available()) {
                    char response = Serial.read();
                    if (response == 'y' || response == 'Y') {
                        Serial.println("ğŸ”„ Registering fingerprint...");
                        sendFingerprintData(fingerID, 90);
                        break;
                    } else if (response == 'n' || response == 'N') {
                        Serial.println("âš ï¸ Fingerprint NOT registered.");
                        break;
                    }
                }
            }
        }
    }
    delay(5000);
}

// ğŸ”¹ Function to Get Fingerprint ID
int getFingerprintID() {
    Serial.println("ğŸ” Scanning for fingerprint...");
    uint8_t p = finger.getImage();

    if (p != FINGERPRINT_OK) return -1;

    p = finger.image2Tz();
    if (p != FINGERPRINT_OK) return -1;

    p = finger.fingerFastSearch();
    if (p == FINGERPRINT_OK) {
        Serial.print("âœ… Found ID: ");
        Serial.println(finger.fingerID);
        return finger.fingerID;
    } else {
        Serial.println("âŒ No match found.");
        return -1;
    }
}

// ğŸ”¹ Function to Check if Fingerprint Exists in Database
bool checkFingerprintInDB(int fingerID) {
    if (WiFi.status() == WL_CONNECTED) {
        HTTPClient http;
        http.begin(checkUrl);
        int httpResponseCode = http.GET();

        if (httpResponseCode == 200) {
            String response = http.getString();
            Serial.println("ğŸ“œ Database Response: " + response);

            StaticJsonDocument<1024> doc;
            deserializeJson(doc, response);
            
            for (JsonVariant fp : doc.as<JsonArray>()) {
                if (fp["fingerID"] == fingerID) {
                    http.end();
                    return true;
                }
            }
        } else {
            Serial.print("âŒ Error fetching data. HTTP Code: ");
            Serial.println(httpResponseCode);
        }
        http.end();
    } else {
        Serial.println("âŒ WiFi Disconnected!");
    }
    return false;
}

// ğŸ”¹ Function to Register New Fingerprint
void sendFingerprintData(int fingerID, int confidence) {
    if (WiFi.status() == WL_CONNECTED) {
        HTTPClient http;
        http.begin(addUrl);
        http.addHeader("Content-Type", "application/json");

        StaticJsonDocument<200> doc;
        doc["fingerID"] = fingerID;
        doc["confidence"] = confidence;
        String jsonData;
        serializeJson(doc, jsonData);

        int httpResponseCode = http.POST(jsonData);
        if (httpResponseCode > 0) {
            String response = http.getString();
            Serial.println("âœ… Server Response: " + response);
        } else {
            Serial.print("âŒ Error in sending request. HTTP Code: ");
            Serial.println(httpResponseCode);
        }
        http.end();
    } else {
        Serial.println("âŒ WiFi Disconnected!");
    }
}
